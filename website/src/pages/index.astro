---
import BaseLayout from '../layouts/BaseLayout.astro';
import LogoCard from '../components/LogoCard.astro';
import institutionIndex from '../data/institutions-index.json';
import { getPrimaryLogoPath, hasSvg, getDisplayName } from '../lib/helpers';
import { CATEGORY_LABELS, CATEGORY_ORDER } from '../lib/labels';
import type { Institution } from '../types/institution';

const institutions = institutionIndex.institutions as Institution[];

// Grupare pe categorii cu ordine prestabilită
const grouped = new Map<string, typeof institutions>();
for (const cat of CATEGORY_ORDER) {
  const items = institutions.filter(i => i.category === cat);
  if (items.length > 0) grouped.set(cat, items);
}

// Categoriile active (cele care au cel puțin o instituție)
const activeCategories = [...grouped.keys()];
---

<BaseLayout>
  <!-- Hero Section -->
  <section class="relative overflow-hidden">
    <div class="absolute inset-0 bg-gradient-to-b from-primary-50/50 to-surface-50 -z-10"></div>

    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 pt-12 pb-8 text-center">
      <!-- Beta badge -->
      <div class="inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded bg-primary-50 border border-primary-100 mb-4">
        <span class="w-1.5 h-1.5 rounded-full bg-primary-500 animate-pulse"></span>
        <span class="text-[10px] font-medium text-primary-700">Versiune Beta &middot; Proiect Civic Open-Source</span>
      </div>

      <!-- Title -->
      <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-primary-900 leading-tight text-balance mb-4">
        Identitatea Vizuală<br />a României, <span class="text-primary-500">digitalizată.</span>
      </h1>

      <!-- Subtitle -->
      <p class="text-sm sm:text-base text-surface-500 max-w-xl mx-auto mb-8 text-balance">
        Registrul open-source pentru logo-uri vectoriale (SVG) ale instituțiilor publice.
        O singură sursă de adevăr.
      </p>

      <!-- NPM Package Installation -->
      <div class="mb-8 max-w-2xl mx-auto">
        <div class="bg-gradient-to-br from-primary-50 to-white border border-primary-100 rounded-lg p-6 shadow-sm">
          <div class="flex items-center justify-center gap-2 mb-3">
            <svg class="w-5 h-5 text-primary-600" fill="currentColor" viewBox="0 0 24 24">
              <path d="M0 10.041v3.833l6.171 3.333v-10l-6.171 3.334zm7.333 0l6.171-3.334v10l-6.171-3.333v-3.333zm6.172-3.333l6.171 3.333v3.334l-6.171-3.334v-3.333zm6.171 10l-6.171-3.333v-3.334l6.171 3.334v3.333z"/>
            </svg>
            <h2 class="text-sm font-semibold text-primary-900">Instalează via NPM</h2>
          </div>
          
          <div class="bg-surface-900 rounded-md p-4 font-mono text-sm mb-3 overflow-x-auto relative">
            <code class="text-green-400">npm install</code>
            <code class="text-white"> @identitate-ro/logos</code>
            <button
              type="button"
              class="copy-npm-btn absolute top-2 right-2 p-1 rounded hover:bg-gray-700 text-gray-400 hover:text-gray-200 transition-colors"
              data-value="npm install @identitate-ro/logos"
              title="Copiază comanda"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
              </svg>
            </button>
          </div>
          
          <p class="text-xs text-surface-600 mb-3">
            Folosește logo-urile direct prin CDN sau instalează pachetul npm pentru integrare în proiectul tău.
          </p>
          
          <div class="flex flex-wrap gap-2 justify-center">
            <a href="/utilizare" class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-primary-700 bg-white border border-primary-200 rounded-md hover:bg-primary-50 transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
              Documentație
            </a>
            <a href="https://www.npmjs.com/package/@identitate-ro/logos" target="_blank" rel="noopener" class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-surface-700 bg-white border border-surface-200 rounded-md hover:bg-surface-50 transition-colors">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                <path d="M0 10.041v3.833l6.171 3.333v-10l-6.171 3.334zm7.333 0l6.171-3.334v10l-6.171-3.333v-3.333zm6.172-3.333l6.171 3.333v3.334l-6.171-3.334v-3.333zm6.171 10l-6.171-3.333v-3.334l6.171 3.334v3.333z"/>
              </svg>
              Vezi pe NPM
            </a>
            <a href="https://github.com/laurentiucotet/IdentitateRO" target="_blank" rel="noopener" class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-surface-700 bg-white border border-surface-200 rounded-md hover:bg-surface-50 transition-colors">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                <path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd" />
              </svg>
              GitHub
            </a>
          </div>
        </div>
      </div>

      <!-- Search Input -->
      <div class="relative max-w-xl mx-auto" id="search-wrapper">
        <div class="absolute inset-y-0 left-0 pl-5 flex items-center pointer-events-none">
          <svg class="w-5 h-5 text-surface-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </div>
        <input
          type="search"
          id="search-input"
          class="search-input pl-12"
          placeholder="Caută „Primăria Iași", „Ministerul Educației"..."
          autocomplete="off"
        />
        <div id="search-hint" class="mt-2 text-xs text-surface-400 hidden">
          <kbd class="px-1.5 py-0.5 bg-surface-100 rounded text-surface-500 font-mono">ESC</kbd> pentru a reseta
        </div>
      </div>
    </div>
  </section>

  <!-- Filter Bar -->
  <section class="sticky top-12 z-30 bg-white/80 backdrop-blur-md border-b border-surface-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-2">
      <div class="flex items-center gap-2 overflow-x-auto pb-1 scrollbar-hide" id="filter-bar">
        <button
          class="category-chip category-chip--active shrink-0"
          data-category="all"
        >
          Toate ({institutions.length})
        </button>
        {activeCategories.map(cat => (
          <button
            class="category-chip category-chip--inactive shrink-0"
            data-category={cat}
          >
            {CATEGORY_LABELS[cat] || cat}
          </button>
        ))}
      </div>
    </div>
  </section>

  <!-- Logo Grid — Grouped by Category -->
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Results info -->
    <div class="flex items-center justify-between mb-4">
      <p id="results-count" class="text-xs text-surface-500">
        {institutions.length} instituții disponibile
      </p>
      <div class="text-xs text-surface-400 hidden sm:block">
        Click pe un card pentru detalii și download
      </div>
    </div>

    <!-- Category Sections -->
    <div id="category-sections">
      {[...grouped.entries()].map(([cat, items]) => (
        <div class="category-section mb-8" data-category-section={cat}>
          <h2 class="text-lg font-semibold text-primary-900 mb-3 flex items-center gap-2">
            {CATEGORY_LABELS[cat] || cat}
            <span class="text-xs font-normal text-surface-400">({items.length})</span>
          </h2>
          <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3 sm:gap-4">
            {items.map((inst) => {
              const logoPath = getPrimaryLogoPath(inst) || '';
              const hasSvgFlag = hasSvg(inst);
              return (
                <LogoCard
                  slug={inst.slug}
                  name={inst.name}
                  shortname={inst.shortname}
                  category={inst.category}
                  logoPath={logoPath}
                  quality={inst.meta.quality}
                  hasSvg={hasSvgFlag}
                  keywords={inst.meta.keywords}
                />
              );
            })}
          </div>
        </div>
      ))}
    </div>

    <!-- Flat Grid (hidden by default, used when filtering/searching) -->
    <div id="logo-grid" class="hidden grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3 sm:gap-4">
      {institutions.map((inst) => {
        const logoPath = getPrimaryLogoPath(inst) || '';
        const hasSvgFlag = hasSvg(inst);
        return (
          <LogoCard
            slug={inst.slug}
            name={inst.name}
            shortname={inst.shortname}
            category={inst.category}
            logoPath={logoPath}
            quality={inst.meta.quality}
            hasSvg={hasSvgFlag}
            keywords={inst.meta.keywords}
          />
        );
      })}
    </div>

    <!-- Empty state -->
    <div id="empty-state" class="hidden py-20 text-center">
      <svg class="w-16 h-16 mx-auto mb-4 text-surface-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <h3 class="text-sm font-semibold text-primary-900 mb-2">Niciun rezultat</h3>
      <p class="text-surface-500 text-xs mb-3">Nu am găsit nicio instituție care să corespundă căutării tale.</p>
      <a href="/solicita" class="btn-primary">Solicită adăugarea</a>
    </div>
  </section>
</BaseLayout>

<!-- Inline JSON data for client-side search & filter -->
<script define:vars={{ institutions: institutionIndex.institutions }}>
  window.__IDENTITATE_DATA__ = institutions;
</script>

<script>
  /**
   * IdentitateRO — Client-side interactivity (v3.0)
   * Search, filter cu suport pentru schema v3.0 (flat structure)
   */

  document.addEventListener('DOMContentLoaded', () => {

  const data = (window as any).__IDENTITATE_DATA__;

  // DOM elements
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const searchHint = document.getElementById('search-hint')!;
  const filterBar = document.getElementById('filter-bar')!;
  const categorySections = document.getElementById('category-sections')!;
  const logoGrid = document.getElementById('logo-grid')!;
  const emptyState = document.getElementById('empty-state')!;
  const resultsCount = document.getElementById('results-count')!;

  // State
  let activeCategory = 'all';
  let searchQuery = '';

  /**
   * Modul de afișare:
   * - "grouped"  → secțiuni pe categorii (default, "Toate" fără search)
   * - "flat"     → grid plat (când se filtrează sau se caută)
   */
  function getViewMode(): 'grouped' | 'flat' {
    return (activeCategory === 'all' && !searchQuery.trim()) ? 'grouped' : 'flat';
  }

  function filterAndSearch() {
    const query = searchQuery.toLowerCase().trim();
    const mode = getViewMode();

    if (mode === 'grouped') {
      // Afișăm secțiuni pe categorii, ascundem flat grid
      categorySections.classList.remove('hidden');
      logoGrid.classList.add('hidden');
      emptyState.classList.add('hidden');
      resultsCount.textContent = `${data.length} instituții disponibile`;
      searchHint.classList.add('hidden');

      // Afișăm toate secțiunile
      categorySections.querySelectorAll<HTMLElement>('[data-category-section]').forEach(section => {
        section.classList.remove('hidden');
      });
      return;
    }

    // Mod flat — ascundem secțiunile, arătăm grid-ul plat
    categorySections.classList.add('hidden');
    logoGrid.classList.remove('hidden');

    const cards = logoGrid.querySelectorAll<HTMLElement>('[data-institution-id]');
    let visibleCount = 0;

    cards.forEach(card => {
      const instSlug = card.dataset.institutionId!;
      const inst = data.find(d => d.slug === instSlug);
      if (!inst) return;

      const matchesCategory = activeCategory === 'all' || inst.category === activeCategory;
      const matchesSearch = !query || [
        inst.name,
        inst.shortname || '',
        inst.description || '',
        inst.category,
        ...(inst.meta.keywords || []),
      ].some((field: string) => field.toLowerCase().includes(query));

      if (matchesCategory && matchesSearch) {
        card.classList.remove('hidden');
        visibleCount++;
      } else {
        card.classList.add('hidden');
      }
    });

    // Update UI
    resultsCount.textContent = `${visibleCount} ${visibleCount === 1 ? 'instituție disponibilă' : 'instituții disponibile'}`;
    emptyState.classList.toggle('hidden', visibleCount > 0);
    logoGrid.classList.toggle('hidden', visibleCount === 0);
    searchHint.classList.toggle('hidden', !query);
  }

  // Search input
  searchInput.addEventListener('input', (e) => {
    searchQuery = (e.target as HTMLInputElement).value;
    filterAndSearch();
  });

  searchInput.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      searchInput.value = '';
      searchQuery = '';
      filterAndSearch();
      searchInput.blur();
    }
  });

  // Category filter buttons
  filterBar.addEventListener('click', (e) => {
    const btn = (e.target as HTMLElement).closest('[data-category]') as HTMLElement;
    if (!btn) return;

    activeCategory = btn.dataset.category!;

    // Update active states
    filterBar.querySelectorAll('[data-category]').forEach(chip => {
      if (chip === btn) {
        chip.classList.remove('category-chip--inactive');
        chip.classList.add('category-chip--active');
      } else {
        chip.classList.remove('category-chip--active');
        chip.classList.add('category-chip--inactive');
      }
    });

    filterAndSearch();
  });

  // Keyboard shortcut: focus search with /
  document.addEventListener('keydown', (e) => {
    if (e.key === '/' && document.activeElement !== searchInput) {
      e.preventDefault();
      searchInput.focus();
    }
  });

  // Initial state
  filterAndSearch();
  });
</script>

<script>
  // Copy functionality for NPM command
  document.addEventListener('DOMContentLoaded', () => {
    const copyNpmBtn = document.querySelector('.copy-npm-btn');
    if (copyNpmBtn) {
      copyNpmBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        e.preventDefault();

        const btn = e.currentTarget as HTMLButtonElement;
        const textToCopy = btn.dataset.value!;

        try {
          await navigator.clipboard.writeText(textToCopy);

          // Visual feedback
          const originalIcon = btn.innerHTML;
          btn.innerHTML = `
            <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
          `;
          setTimeout(() => { btn.innerHTML = originalIcon; }, 2000);

        } catch (err) {
          console.error('Failed to copy:', err);
          const originalIcon = btn.innerHTML;
          btn.innerHTML = `
            <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          `;
          setTimeout(() => { btn.innerHTML = originalIcon; }, 2000);
        }
      });
    }
  });
</script>
