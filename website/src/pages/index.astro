---
import BaseLayout from '../layouts/BaseLayout.astro';
import LogoCard from '../components/LogoCard.astro';
import institutionIndex from '../data/institutions-index.json';
import { getPrimaryLogoPath, hasSvg, getDisplayName } from '../lib/helpers';
import { CATEGORY_LABELS, CATEGORY_ORDER } from '../lib/labels';

const institutions = institutionIndex.institutions as any[];

// Grupare pe categorii cu ordine prestabilită
const grouped = new Map<string, typeof institutions>();
for (const cat of CATEGORY_ORDER) {
  const items = institutions.filter(i => i.institution.category === cat);
  if (items.length > 0) grouped.set(cat, items);
}

// Categoriile active (cele care au cel puțin o instituție)
const activeCategories = [...grouped.keys()];
---

<BaseLayout>
  <!-- Hero Section -->
  <section class="relative overflow-hidden">
    <div class="absolute inset-0 bg-gradient-to-b from-primary-50/50 to-surface-50 -z-10"></div>

    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 pt-12 pb-8 text-center">
      <!-- Beta badge -->
      <div class="inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded bg-primary-50 border border-primary-100 mb-4">
        <span class="w-1.5 h-1.5 rounded-full bg-primary-500 animate-pulse"></span>
        <span class="text-[10px] font-medium text-primary-700">Versiune Beta &middot; Proiect Civic Open-Source</span>
      </div>

      <!-- Title -->
      <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-primary-900 leading-tight text-balance mb-4">
        Identitatea Vizuală<br />a României, <span class="text-primary-500">digitalizată.</span>
      </h1>

      <!-- Subtitle -->
      <p class="text-sm sm:text-base text-surface-500 max-w-xl mx-auto mb-8 text-balance">
        Registrul open-source pentru logo-uri vectoriale (SVG) ale instituțiilor publice.
        O singură sursă de adevăr.
      </p>

      <!-- Search Input -->
      <div class="relative max-w-xl mx-auto" id="search-wrapper">
        <div class="absolute inset-y-0 left-0 pl-5 flex items-center pointer-events-none">
          <svg class="w-5 h-5 text-surface-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </div>
        <input
          type="search"
          id="search-input"
          class="search-input pl-12"
          placeholder="Caută „Primăria Iași", „Ministerul Educației"..."
          autocomplete="off"
        />
        <div id="search-hint" class="mt-2 text-xs text-surface-400 hidden">
          <kbd class="px-1.5 py-0.5 bg-surface-100 rounded text-surface-500 font-mono">ESC</kbd> pentru a reseta
        </div>
      </div>
    </div>
  </section>

  <!-- Filter Bar -->
  <section class="sticky top-12 z-30 bg-white/80 backdrop-blur-md border-b border-surface-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-2">
      <div class="flex items-center gap-2 overflow-x-auto pb-1 scrollbar-hide" id="filter-bar">
        <button
          class="category-chip category-chip--active shrink-0"
          data-category="all"
        >
          Toate ({institutions.length})
        </button>
        {activeCategories.map(cat => (
          <button
            class="category-chip category-chip--inactive shrink-0"
            data-category={cat}
          >
            {CATEGORY_LABELS[cat] || cat}
          </button>
        ))}
      </div>
    </div>
  </section>

  <!-- Logo Grid — Grouped by Category -->
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Results info -->
    <div class="flex items-center justify-between mb-4">
      <p id="results-count" class="text-xs text-surface-500">
        {institutions.length} instituții disponibile
      </p>
      <div class="text-xs text-surface-400 hidden sm:block">
        Click pe un card pentru detalii și download
      </div>
    </div>

    <!-- Category Sections -->
    <div id="category-sections">
      {[...grouped.entries()].map(([cat, items]) => (
        <div class="category-section mb-8" data-category-section={cat}>
          <h2 class="text-lg font-semibold text-primary-900 mb-3 flex items-center gap-2">
            {CATEGORY_LABELS[cat] || cat}
            <span class="text-xs font-normal text-surface-400">({items.length})</span>
          </h2>
          <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3 sm:gap-4">
            {items.map((inst: any) => {
              const logoPath = getPrimaryLogoPath(inst) || '';
              const hasSvgFlag = hasSvg(inst);
              return (
                <LogoCard
                  id={inst.id}
                  name={inst.institution.name}
                  shortName={inst.institution.shortName}
                  acronym={inst.institution.acronym}
                  category={inst.institution.category}
                  logoPath={logoPath}
                  quality={inst.meta.quality}
                  hasSvg={hasSvgFlag}
                  tags={inst.meta.tags}
                />
              );
            })}
          </div>
        </div>
      ))}
    </div>

    <!-- Flat Grid (hidden by default, used when filtering/searching) -->
    <div id="logo-grid" class="hidden grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3 sm:gap-4">
      {institutions.map((inst: any) => {
        const logoPath = getPrimaryLogoPath(inst) || '';
        const hasSvgFlag = hasSvg(inst);
        return (
          <LogoCard
            id={inst.id}
            name={inst.institution.name}
            shortName={inst.institution.shortName}
            acronym={inst.institution.acronym}
            category={inst.institution.category}
            logoPath={logoPath}
            quality={inst.meta.quality}
            hasSvg={hasSvgFlag}
            tags={inst.meta.tags}
          />
        );
      })}
    </div>

    <!-- Empty state -->
    <div id="empty-state" class="hidden py-20 text-center">
      <svg class="w-16 h-16 mx-auto mb-4 text-surface-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <h3 class="text-sm font-semibold text-primary-900 mb-2">Niciun rezultat</h3>
      <p class="text-surface-500 text-xs mb-3">Nu am găsit nicio instituție care să corespundă căutării tale.</p>
      <a href="/solicita" class="btn-primary">Solicită adăugarea</a>
    </div>
  </section>
</BaseLayout>

<!-- Inline JSON data for client-side search & filter -->
<script define:vars={{ institutions: institutionIndex.institutions }}>
  window.__IDENTITATE_DATA__ = institutions;
</script>

<script>
  /**
   * IdentitateRO — Client-side interactivity (v2.0)
   * Search, filter cu suport pentru schema v2.0 (nested structure)
   */

  document.addEventListener('DOMContentLoaded', () => {

  const data: any[] = (window as any).__IDENTITATE_DATA__;

  // DOM elements
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const searchHint = document.getElementById('search-hint')!;
  const filterBar = document.getElementById('filter-bar')!;
  const categorySections = document.getElementById('category-sections')!;
  const logoGrid = document.getElementById('logo-grid')!;
  const emptyState = document.getElementById('empty-state')!;
  const resultsCount = document.getElementById('results-count')!;

  // State
  let activeCategory = 'all';
  let searchQuery = '';

  /**
   * Modul de afișare:
   * - "grouped"  → secțiuni pe categorii (default, "Toate" fără search)
   * - "flat"     → grid plat (când se filtrează sau se caută)
   */
  function getViewMode(): 'grouped' | 'flat' {
    return (activeCategory === 'all' && !searchQuery.trim()) ? 'grouped' : 'flat';
  }

  function filterAndSearch() {
    const query = searchQuery.toLowerCase().trim();
    const mode = getViewMode();

    if (mode === 'grouped') {
      // Afișăm secțiuni pe categorii, ascundem flat grid
      categorySections.classList.remove('hidden');
      logoGrid.classList.add('hidden');
      emptyState.classList.add('hidden');
      resultsCount.textContent = `${data.length} instituții disponibile`;
      searchHint.classList.add('hidden');

      // Afișăm toate secțiunile
      categorySections.querySelectorAll<HTMLElement>('[data-category-section]').forEach(section => {
        section.classList.remove('hidden');
      });
      return;
    }

    // Mod flat — ascundem secțiunile, arătăm grid-ul plat
    categorySections.classList.add('hidden');
    logoGrid.classList.remove('hidden');

    const cards = logoGrid.querySelectorAll<HTMLElement>('[data-institution-id]');
    let visibleCount = 0;

    cards.forEach(card => {
      const instId = card.dataset.institutionId!;
      const inst = data.find(d => d.id === instId);
      if (!inst) return;

      const info = inst.institution;
      const meta = inst.meta;

      const matchesCategory = activeCategory === 'all' || info.category === activeCategory;
      const matchesSearch = !query || [
        info.name,
        info.shortName || '',
        info.acronym || '',
        info.description || '',
        info.category,
        ...(meta.tags || []),
      ].some((field: string) => field.toLowerCase().includes(query));

      if (matchesCategory && matchesSearch) {
        card.classList.remove('hidden');
        visibleCount++;
      } else {
        card.classList.add('hidden');
      }
    });

    // Update UI
    resultsCount.textContent = `${visibleCount} ${visibleCount === 1 ? 'instituție disponibilă' : 'instituții disponibile'}`;
    emptyState.classList.toggle('hidden', visibleCount > 0);
    logoGrid.classList.toggle('hidden', visibleCount === 0);
    searchHint.classList.toggle('hidden', !query);
  }

  // Search input
  searchInput.addEventListener('input', (e) => {
    searchQuery = (e.target as HTMLInputElement).value;
    filterAndSearch();
  });

  searchInput.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      searchInput.value = '';
      searchQuery = '';
      filterAndSearch();
      searchInput.blur();
    }
  });

  // Category filter buttons
  filterBar.addEventListener('click', (e) => {
    const btn = (e.target as HTMLElement).closest('[data-category]') as HTMLElement;
    if (!btn) return;

    activeCategory = btn.dataset.category!;

    // Update active states
    filterBar.querySelectorAll('[data-category]').forEach(chip => {
      if (chip === btn) {
        chip.classList.remove('category-chip--inactive');
        chip.classList.add('category-chip--active');
      } else {
        chip.classList.remove('category-chip--active');
        chip.classList.add('category-chip--inactive');
      }
    });

    filterAndSearch();
  });

  // Keyboard shortcut: focus search with /
  document.addEventListener('keydown', (e) => {
    if (e.key === '/' && document.activeElement !== searchInput) {
      e.preventDefault();
      searchInput.focus();
    }
  });

  // Initial state
  filterAndSearch();
  });
</script>
