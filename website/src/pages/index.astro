---
import BaseLayout from '../layouts/BaseLayout.astro';
import LogoCard from '../components/LogoCard.astro';
import institutionIndex from '../data/institutions-index.json';

const institutions = institutionIndex.institutions;

// Categoriile active (cele care au cel puțin o instituție)
const activeCategories = [...new Set(institutions.map(i => i.category))];

const categoryLabels: Record<string, string> = {
  'guvern': 'Guvern',
  'minister': 'Ministere',
  'primarie': 'Primării',
  'consiliu-judetean': 'Consilii Județene',
  'prefectura': 'Prefecturi',
  'agentie': 'Agenții',
  'autoritate': 'Autorități',
  'proiect-ue': 'Proiecte UE',
  'institutie-cultura': 'Cultură',
  'altele': 'Altele',
};
---

<BaseLayout>
  <!-- Hero Section -->
  <section class="relative overflow-hidden">
    <!-- Subtle gradient background -->
    <div class="absolute inset-0 bg-gradient-to-b from-primary-50/50 to-surface-50 -z-10"></div>

    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 pt-12 pb-8 text-center">
      <!-- Beta badge -->
      <div class="inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded bg-primary-50 border border-primary-100 mb-4">
        <span class="w-1.5 h-1.5 rounded-full bg-primary-500 animate-pulse"></span>
        <span class="text-[10px] font-medium text-primary-700">Versiune Beta &middot; Proiect Civic Open-Source</span>
      </div>

      <!-- Title -->
      <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-primary-900 leading-tight text-balance mb-4">
        Identitatea Vizuală<br />a României, <span class="text-primary-500">digitalizată.</span>
      </h1>

      <!-- Subtitle -->
      <p class="text-sm sm:text-base text-surface-500 max-w-xl mx-auto mb-8 text-balance">
        Registrul open-source pentru logo-uri vectoriale (SVG) ale instituțiilor publice.
        O singură sursă de adevăr.
      </p>

      <!-- Search Input -->
      <div class="relative max-w-xl mx-auto" id="search-wrapper">
        <div class="absolute inset-y-0 left-0 pl-5 flex items-center pointer-events-none">
          <svg class="w-5 h-5 text-surface-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </div>
        <input
          type="search"
          id="search-input"
          class="search-input pl-12"
          placeholder="Caută „Primăria Iași", „Ministerul Educației"..."
          autocomplete="off"
        />
        <div id="search-hint" class="mt-2 text-xs text-surface-400 hidden">
          <kbd class="px-1.5 py-0.5 bg-surface-100 rounded text-surface-500 font-mono">ESC</kbd> pentru a reseta
        </div>
      </div>
    </div>
  </section>

  <!-- Filter Bar -->
  <section class="sticky top-12 z-30 bg-white/80 backdrop-blur-md border-b border-surface-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-2">
      <div class="flex items-center gap-2 overflow-x-auto pb-1 scrollbar-hide" id="filter-bar">
        <button
          class="category-chip category-chip--active shrink-0"
          data-category="all"
        >
          Toate ({institutions.length})
        </button>
        {activeCategories.map(cat => (
          <button
            class="category-chip category-chip--inactive shrink-0"
            data-category={cat}
          >
            {categoryLabels[cat] || cat}
          </button>
        ))}
      </div>
    </div>
  </section>

  <!-- Logo Grid -->
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Results info -->
    <div class="flex items-center justify-between mb-4">
      <p id="results-count" class="text-xs text-surface-500">
        {institutions.length} instituții disponibile
      </p>
      <div class="text-xs text-surface-400 hidden sm:block">
        Click pe un card pentru detalii și download
      </div>
    </div>

    <!-- Grid -->
    <div id="logo-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3 sm:gap-4">
      {institutions.map(inst => {
        const primarySvg = inst.assets.find(a => a.format === 'svg');
        const primaryAsset = primarySvg || inst.assets[0];
        return (
          <LogoCard
            id={inst.id}
            name={inst.name}
            shortName={inst.shortName}
            abbreviation={inst.abbreviation}
            category={inst.category}
            logoPath={primaryAsset?.path || ''}
            quality={inst.quality}
            hasSvg={!!primarySvg}
          />
        );
      })}
    </div>

    <!-- Empty state -->
    <div id="empty-state" class="hidden py-20 text-center">
      <svg class="w-16 h-16 mx-auto mb-4 text-surface-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <h3 class="text-sm font-semibold text-primary-900 mb-2">Niciun rezultat</h3>
      <p class="text-surface-500 text-xs mb-3">Nu am găsit nicio instituție care să corespundă căutării tale.</p>
      <a href="/solicita" class="btn-primary">Solicită adăugarea</a>
    </div>
  </section>
</BaseLayout>

<!-- Inline JSON data for client-side search & modal -->
<script define:vars={{ institutions: institutionIndex.institutions }}>
  window.__IDENTITATE_DATA__ = institutions;
</script>

<script>
  /**
   * IdentitateRO - Client-side interactivity
   * Search, filter, and modal logic
   */

  interface InstitutionData {
    id: string;
    name: string;
    shortName?: string;
    abbreviation?: string;
    category: string;
    description?: string;
    colors: Array<{ name: string; hex: string; pantone?: string; cmyk?: string; rgb?: string }>;
    assets: Array<{ variant: string; format: string; path: string; width?: number; height?: number }>;
    resources: {
      website?: string;
      brandManual?: string;
      fontPrimary?: string;
      fontSecondary?: string;
      usageNotes?: string;
    };
    updatedAt: string;
    quality: string;
  }

  const data: InstitutionData[] = (window as any).__IDENTITATE_DATA__;

  // DOM elements
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const searchHint = document.getElementById('search-hint')!;
  const filterBar = document.getElementById('filter-bar')!;
  const logoGrid = document.getElementById('logo-grid')!;
  const emptyState = document.getElementById('empty-state')!;
  const resultsCount = document.getElementById('results-count')!;

  // State
  let activeCategory = 'all';
  let searchQuery = '';

  // ═══ SEARCH & FILTER ═══

  function filterAndSearch() {
    const cards = logoGrid.querySelectorAll<HTMLElement>('[data-institution-id]');
    let visibleCount = 0;
    const query = searchQuery.toLowerCase().trim();

    cards.forEach(card => {
      const instId = card.dataset.institutionId!;
      const inst = data.find(d => d.id === instId);
      if (!inst) return;

      const matchesCategory = activeCategory === 'all' || inst.category === activeCategory;
      const matchesSearch = !query || [
        inst.name,
        inst.shortName || '',
        inst.abbreviation || '',
        inst.description || '',
        inst.category,
      ].some(field => field.toLowerCase().includes(query));

      if (matchesCategory && matchesSearch) {
        card.style.display = '';
        visibleCount++;
      } else {
        card.style.display = 'none';
      }
    });

    // Update UI
    resultsCount.textContent = `${visibleCount} ${visibleCount === 1 ? 'instituție disponibilă' : 'instituții disponibile'}`;
    emptyState.classList.toggle('hidden', visibleCount > 0);
    logoGrid.classList.toggle('hidden', visibleCount === 0);
    searchHint.classList.toggle('hidden', !query);
  }

  // Search input
  searchInput.addEventListener('input', (e) => {
    searchQuery = (e.target as HTMLInputElement).value;
    filterAndSearch();
  });

  searchInput.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      searchInput.value = '';
      searchQuery = '';
      filterAndSearch();
      searchInput.blur();
    }
  });

  // Category filter buttons
  filterBar.addEventListener('click', (e) => {
    const btn = (e.target as HTMLElement).closest('[data-category]') as HTMLElement;
    if (!btn) return;

    activeCategory = btn.dataset.category!;

    // Update active states
    filterBar.querySelectorAll('[data-category]').forEach(chip => {
      if (chip === btn) {
        chip.classList.remove('category-chip--inactive');
        chip.classList.add('category-chip--active');
      } else {
        chip.classList.remove('category-chip--active');
        chip.classList.add('category-chip--inactive');
      }
    });

    filterAndSearch();
  });

  // Keyboard shortcut: focus search with /
  document.addEventListener('keydown', (e) => {
    if (e.key === '/' && document.activeElement !== searchInput) {
      e.preventDefault();
      searchInput.focus();
    }
  });
</script>
